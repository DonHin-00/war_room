import unittest
import os
import sys
import shutil
import tempfile

# Add parent dir to path
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
import utils
import config

class TestExploits(unittest.TestCase):
    def setUp(self):
        self.test_dir = tempfile.mkdtemp()
        self.war_zone = os.path.join(self.test_dir, "battlefield")
        os.makedirs(self.war_zone)

        # Patch config to point to temp dir
        self.orig_paths = config.PATHS.copy()
        config.PATHS["WAR_ZONE"] = self.war_zone
        config.PATHS["BASE_DIR"] = self.test_dir

    def tearDown(self):
        shutil.rmtree(self.test_dir)
        config.PATHS = self.orig_paths

    def test_path_traversal_write(self):
        # Attempt to write outside BASE_DIR
        # Use a system temp file that is definitely outside test_dir
        with tempfile.NamedTemporaryFile(delete=False) as tf:
            target_path = tf.name
        os.remove(target_path) # Ensure it doesn't exist

        try:
            utils.safe_file_write(target_path, "EXPLOITED")
        except PermissionError:
            pass # Caught!
        except Exception:
            pass

        if os.path.exists(target_path):
            os.remove(target_path)
            self.fail("Path traversal vulnerability detected in safe_file_write")

    def test_path_traversal_read(self):
        # Create file outside BASE_DIR
        with tempfile.NamedTemporaryFile(mode='w', delete=False) as tf:
            tf.write("SECRET_KEY")
            target_path = tf.name

        try:
            content = utils.safe_file_read(target_path)
            if content == "SECRET_KEY":
                self.fail("Path traversal vulnerability detected in safe_file_read")
        finally:
            if os.path.exists(target_path):
                os.remove(target_path)

if __name__ == '__main__':
    unittest.main()
