#!/usr/bin/env python3
import socket
import json
import time
import random
import sys
import os

# Add root to path
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
import config
import utils

logger = utils.setup_logging("ExploitRunner", config.RED_LOG)

class ExploitRunner:
    def __init__(self):
        self.sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, socket.IPPROTO_UDP)

    def fuzz_swarm(self):
        """Send malformed JSON to Blue Swarm."""
        target = ('224.2.2.2', 5008) # Config
        fuzz_payloads = [
            b"{ 'broken': json }",
            b"A" * 1024, # Buffer overflow attempt
            json.dumps({"type": "IOC_Found", "ioc": None}).encode(), # Logic error
            json.dumps({"sender": "ADMIN", "type": "SHUTDOWN"}).encode() # Spoofing
        ]

        payload = random.choice(fuzz_payloads)
        logger.info(f"üí£ EXPLOIT: Fuzzing Swarm with {len(payload)} bytes")
        try:
            self.sock.sendto(payload, target)
        except Exception as e:
            logger.error(f"Fuzz failed: {e}")

    def replay_attack(self):
        """Replay valid messages to cause spam."""
        # We need to capture one first. For sim, we forge one with old timestamp.
        msg = {
            "sender": "REPLAY_BOT",
            "type": "VOUCH",
            "target": "VICTIM",
            "ts": time.time() - 3600 # Old
        }
        logger.info("‚è≥ EXPLOIT: Launching Replay Attack")
        for _ in range(10):
            try:
                self.sock.sendto(json.dumps(msg).encode(), ('224.2.2.2', 5008))
            except: pass

    def run(self):
        print("üè¥‚Äç‚ò†Ô∏è Exploit Runner Active...")
        while True:
            self.fuzz_swarm()
            time.sleep(2)
            self.replay_attack()
            time.sleep(5)

if __name__ == "__main__":
    runner = ExploitRunner()
    try:
        runner.run()
    except KeyboardInterrupt:
        pass
